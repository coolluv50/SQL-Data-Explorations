# SQL-Data-Explorations
# This project examines different case studies (corresponding files in 'go to file' folder) for data exploration. Respective query for each case study below the case study title

-- Ensure master database is in use

          use master;


 --Creating a database for SQL Data Exploration projects
 
          Create Database [Data Exploration]
          go
	  
--selecting the Data Exploration Database

          Use [Data Exploration]
          go
# BUSES AND PASSENGERS
--Creating the tables as specified by the buses and passengers case study
	
	create table buses (
		id integer primary key,
		origin varchar(30) not null,
		destination varchar(30) not null,
		time varchar(30) not null,
		unique (origin, destination, time)
		);
	create table passengers (
		id integer primary key,
		origin varchar(30) not null,
		destination varchar(30) not null,
		time varchar not null
		);
		
--Inserting values into both tables to verify correctness of result generated by query later for given examples 1.

	insert into buses values (10, 'Warsaw', 'Berlin', '10:55');

	insert into buses values (20, 'Berlin', 'Paris', '06:20');

	insert into buses values (21, 'Berlin', 'Paris', '14:00');

	insert into buses values (22, 'Berlin', 'Paris', '21:40');

	insert into buses values (30, 'Paris', 'Madrid', '13:30');

	insert into passengers values (1, 'Paris', 'Madrid', '13:30');

	insert into passengers values (2, 'Paris', 'Madrid', '13:31');

	insert into passengers values (10, 'Warsaw', 'Paris', '10:00');

	insert into passengers values (11, 'Warsaw', 'Berlin', '22:31');

	insert into passengers values (40, 'Berlin', 'Paris', '06:15');

	insert into passengers values (41, 'Berlin', 'Paris', '06:50');

	insert into passengers values (42, 'Berlin', 'Paris', '07:12');

	insert into passengers values (43, 'Berlin', 'Paris', '12:03');

	insert into passengers values (44, 'Berlin', 'Paris', '20:00')
	
--Query to explore dataset and generate required report for buses and passengers
	
	Select b.id, count(Passengers_id) as [PassengersOnBoard]
	from
	buses b
	left join
		(Select id, Passengers_id, possibility_rank
		from
		(select id, Passengers_id, row_number()over (partition by passengers_id order by passengers_id, bus_departure_time) as possibility_rank



		from
			(select buses.id, buses.origin, buses.destination, buses.time as bus_departure_time, passengers.id as passengers_id, passengers.time as passengers_arrival_time
			from buses
			inner join
			passengers
			on buses.origin=passengers.origin and buses.destination=passengers.destination and passengers.time <= buses.time
			) as sub1		--this subquery aliased as sub1 inner joins buses and passengers where destination and origin aligns and time of arrival by 								--passenger is less than or equals to bus' departure time.
		)sub2				--thsi subquery asigns rank to the number of possible buses a passenger can board
		where possibility_rank =1
		) sub3				-- this assigns passnegrs to buses with the earliest possbile departure 
	on b.id=sub3.id  

# TRADES AND COMPANIES
-- Creating the two tables as specified in the Trades and Company case study

	  create table companies (
          name varchar (30) not null,
          country varchar (30) not null,
          unique (name)
          );

          create table trades (
          id integer not null,
          seller varchar (30) not null,
          buyer varchar (30) not null,
          value integer not null,
          unique (id)
          );
	  
--TRADES AND COMPANIES- Inserting values into both tables to verify correctness of result generated by query later

          insert into companies values ('Alice s.p.', 'Wonderland');
          insert into companies values ('Y-zap', 'Wonderland');

          insert into companies values ('Absolute', 'Mathlands');

          insert into companies values ('Arcus t.g.', 'Mathlands');

          insert into companies values ('Lil Mermaid', 'Underwater Kingdom');

          insert into companies values ('None at all', 'Nothingland');

          insert into trades values (20121107, 'Lil Mermaid', 'Alice s.p.', 10);

          insert into trades values (20123112, 'Arcus t.g.', 'Y-zap', 30);

          insert into trades values (20120125, 'Alice s.p.', 'Arcus t.g.', 100);

          insert into trades values (20120216, 'Lil Mermaid', 'Absolute', 30);

          insert into trades values (20120217, 'Lil Mermaid', 'Absolute', 50);
	  
	  
TRADES AND COMPANIES --query to explore dataset and generate required report for trades and companies
 
	select country, case when sum(exports) is null then 0 else sum(exports) end as exports,
	case when sum(imports) is null then 0 else sum(imports) end as imports
	from
	(select c.country, c.name, e.exports, i.imports
	from companies c
	left join								-- Left joining companies table to subquery e on name
			(select seller as name , sum(value) as exports
			from trades
			group by seller) e					--Subquery aggregating the exports by seller (company) aliased as e
	on c.name=e.name
	left join								--Left joining companies table on subquery i

			(select buyer as name , sum(value) as imports
			from trades
			group by buyer) i					--Subquery aggreagting the imports by seller aliased as i
	on c.name=i.name
	) final
	group by country
	order by country;
